-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS app.users
(
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    name character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT users_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.chi_tiet_phieu_muon
(
    id bigserial NOT NULL,
    phieu_muon_id bigint NOT NULL,
    sach_id bigint NOT NULL,
    ngay_muon timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_den_han date NOT NULL,
    ngay_tra timestamp without time zone,
    trang_thai character varying(20) COLLATE pg_catalog."default" NOT NULL DEFAULT 'BORROWED'::character varying,
    tien_phat numeric(12, 2) NOT NULL DEFAULT 0,
    ghi_chu text COLLATE pg_catalog."default",
    CONSTRAINT chi_tiet_phieu_muon_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.nguoi_dung
(
    id bigserial NOT NULL,
    ma_nguoi_dung character varying(50) COLLATE pg_catalog."default" NOT NULL,
    ho_ten character varying(100) COLLATE pg_catalog."default" NOT NULL,
    ngay_sinh date,
    dia_chi character varying(255) COLLATE pg_catalog."default",
    so_dien_thoai character varying(20) COLLATE pg_catalog."default",
    email character varying(100) COLLATE pg_catalog."default",
    mat_khau_hash character varying(255) COLLATE pg_catalog."default" NOT NULL,
    vai_tro character varying(20) COLLATE pg_catalog."default" NOT NULL DEFAULT 'DOCGIA'::character varying,
    quota_sach integer NOT NULL DEFAULT 5,
    trang_thai character varying(20) COLLATE pg_catalog."default" NOT NULL DEFAULT 'ACTIVE'::character varying,
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT nguoi_dung_pkey PRIMARY KEY (id),
    CONSTRAINT nguoi_dung_email_key UNIQUE (email),
    CONSTRAINT nguoi_dung_ma_nguoi_dung_key UNIQUE (ma_nguoi_dung)
);

CREATE TABLE IF NOT EXISTS public.phieu_muon
(
    id bigserial NOT NULL,
    ma_phieu character varying(50) COLLATE pg_catalog."default" NOT NULL,
    doc_gia_id bigint NOT NULL,
    nhan_vien_id bigint,
    ngay_lap timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    trang_thai character varying(20) COLLATE pg_catalog."default" NOT NULL DEFAULT 'OPEN'::character varying,
    ghi_chu text COLLATE pg_catalog."default",
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT phieu_muon_pkey PRIMARY KEY (id),
    CONSTRAINT phieu_muon_ma_phieu_key UNIQUE (ma_phieu)
);

CREATE TABLE IF NOT EXISTS public.sach
(
    id bigserial NOT NULL,
    ma_sach character varying(50) COLLATE pg_catalog."default" NOT NULL,
    tieu_de character varying(255) COLLATE pg_catalog."default" NOT NULL,
    tac_gia_hien_thi character varying(255) COLLATE pg_catalog."default",
    nam_xuat_ban integer,
    mo_ta text COLLATE pg_catalog."default",
    the_loai_id bigint,
    so_luong_tong integer NOT NULL DEFAULT 0,
    so_luong_con integer NOT NULL DEFAULT 0,
    co_ban_dien_tu boolean NOT NULL DEFAULT false,
    file_url text COLLATE pg_catalog."default",
    cover_url text COLLATE pg_catalog."default",
    so_trang_dien_tu integer,
    dinh_dang_dien_tu character varying(20) COLLATE pg_catalog."default",
    an_hien boolean NOT NULL DEFAULT true,
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT sach_pkey PRIMARY KEY (id),
    CONSTRAINT sach_ma_sach_key UNIQUE (ma_sach)
);

CREATE TABLE IF NOT EXISTS public.sach_tac_gia
(
    sach_id bigint NOT NULL,
    tac_gia_id bigint NOT NULL,
    CONSTRAINT sach_tac_gia_pkey PRIMARY KEY (sach_id, tac_gia_id)
);

CREATE TABLE IF NOT EXISTS public.sach_tag
(
    sach_id bigint NOT NULL,
    tag_id bigint NOT NULL,
    CONSTRAINT sach_tag_pkey PRIMARY KEY (sach_id, tag_id)
);

CREATE TABLE IF NOT EXISTS public.tac_gia
(
    id bigserial NOT NULL,
    ten_tac_gia character varying(100) COLLATE pg_catalog."default" NOT NULL,
    tieu_su text COLLATE pg_catalog."default",
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT tac_gia_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.tag
(
    id bigserial NOT NULL,
    ten_tag character varying(100) COLLATE pg_catalog."default" NOT NULL,
    mo_ta text COLLATE pg_catalog."default",
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT tag_pkey PRIMARY KEY (id),
    CONSTRAINT tag_ten_tag_key UNIQUE (ten_tag)
);

CREATE TABLE IF NOT EXISTS public.the_doc_sach_dien_tu
(
    id bigserial NOT NULL,
    nguoi_dung_id bigint NOT NULL,
    sach_id bigint NOT NULL,
    trang_thai character varying(20) COLLATE pg_catalog."default" NOT NULL DEFAULT 'READING'::character varying,
    thoi_gian_bat_dau timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    thoi_gian_ket_thuc timestamp without time zone,
    han_doc timestamp without time zone,
    tien_do numeric(5, 2) NOT NULL DEFAULT 0,
    trang_hien_tai integer,
    ghi_chu text COLLATE pg_catalog."default",
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT the_doc_sach_dien_tu_pkey PRIMARY KEY (id),
    CONSTRAINT uq_the_doc UNIQUE (nguoi_dung_id, sach_id, trang_thai)
);

CREATE TABLE IF NOT EXISTS public.the_loai
(
    id bigserial NOT NULL,
    ma_the_loai character varying(50) COLLATE pg_catalog."default",
    ten_the_loai character varying(100) COLLATE pg_catalog."default" NOT NULL,
    mo_ta text COLLATE pg_catalog."default",
    trang_thai character varying(20) COLLATE pg_catalog."default" NOT NULL DEFAULT 'ACTIVE'::character varying,
    ngay_tao timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT the_loai_pkey PRIMARY KEY (id),
    CONSTRAINT the_loai_ma_the_loai_key UNIQUE (ma_the_loai)
);

ALTER TABLE IF EXISTS public.chi_tiet_phieu_muon
    ADD CONSTRAINT chi_tiet_phieu_muon_phieu_muon_id_fkey FOREIGN KEY (phieu_muon_id)
    REFERENCES public.phieu_muon (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_ctpm_phieu_muon
    ON public.chi_tiet_phieu_muon(phieu_muon_id);


ALTER TABLE IF EXISTS public.chi_tiet_phieu_muon
    ADD CONSTRAINT chi_tiet_phieu_muon_sach_id_fkey FOREIGN KEY (sach_id)
    REFERENCES public.sach (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_ctpm_sach
    ON public.chi_tiet_phieu_muon(sach_id);


ALTER TABLE IF EXISTS public.phieu_muon
    ADD CONSTRAINT phieu_muon_doc_gia_id_fkey FOREIGN KEY (doc_gia_id)
    REFERENCES public.nguoi_dung (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_phieu_muon_doc_gia
    ON public.phieu_muon(doc_gia_id);


ALTER TABLE IF EXISTS public.phieu_muon
    ADD CONSTRAINT phieu_muon_nhan_vien_id_fkey FOREIGN KEY (nhan_vien_id)
    REFERENCES public.nguoi_dung (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.sach
    ADD CONSTRAINT sach_the_loai_id_fkey FOREIGN KEY (the_loai_id)
    REFERENCES public.the_loai (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_sach_the_loai
    ON public.sach(the_loai_id);


ALTER TABLE IF EXISTS public.sach_tac_gia
    ADD CONSTRAINT sach_tac_gia_sach_id_fkey FOREIGN KEY (sach_id)
    REFERENCES public.sach (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.sach_tac_gia
    ADD CONSTRAINT sach_tac_gia_tac_gia_id_fkey FOREIGN KEY (tac_gia_id)
    REFERENCES public.tac_gia (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_sach_tac_gia_tac_gia
    ON public.sach_tac_gia(tac_gia_id);


ALTER TABLE IF EXISTS public.sach_tag
    ADD CONSTRAINT sach_tag_sach_id_fkey FOREIGN KEY (sach_id)
    REFERENCES public.sach (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.sach_tag
    ADD CONSTRAINT sach_tag_tag_id_fkey FOREIGN KEY (tag_id)
    REFERENCES public.tag (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_sach_tag_tag
    ON public.sach_tag(tag_id);


ALTER TABLE IF EXISTS public.the_doc_sach_dien_tu
    ADD CONSTRAINT the_doc_sach_dien_tu_nguoi_dung_id_fkey FOREIGN KEY (nguoi_dung_id)
    REFERENCES public.nguoi_dung (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.the_doc_sach_dien_tu
    ADD CONSTRAINT the_doc_sach_dien_tu_sach_id_fkey FOREIGN KEY (sach_id)
    REFERENCES public.sach (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_the_doc_sach
    ON public.the_doc_sach_dien_tu(sach_id);

END;