-- =========================
-- 1) NGUOI_DUNG (USER)
-- =========================
CREATE TABLE IF NOT EXISTS public.nguoi_dung (
    id bigserial PRIMARY KEY,
    ma_nguoi_dung varchar(50) NOT NULL UNIQUE,
    ho_ten varchar(100) NOT NULL,
    ngay_sinh date,
    dia_chi varchar(255),
    so_dien_thoai varchar(20),
    email varchar(100) UNIQUE,
    mat_khau_hash varchar(255) NOT NULL,
    vai_tro varchar(20) NOT NULL DEFAULT 'DOCGIA', -- DOCGIA / ADMIN
    quota_sach int NOT NULL DEFAULT 5 CHECK (quota_sach >= 0),
    trang_thai varchar(20) NOT NULL DEFAULT 'ACTIVE', -- ACTIVE/BLOCKED
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_nguoi_dung_ho_ten ON public.nguoi_dung(ho_ten);



-- =========================
-- 2) THE_LOAI
-- =========================
CREATE TABLE IF NOT EXISTS public.the_loai (
    id bigserial PRIMARY KEY,
    ma_the_loai varchar(50) UNIQUE,
    ten_the_loai varchar(100) NOT NULL,
    mo_ta text,
    trang_thai varchar(20) NOT NULL DEFAULT 'ACTIVE',
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_the_loai_ten ON public.the_loai(ten_the_loai);



-- =========================
-- 3) TAC_GIA
-- =========================
CREATE TABLE IF NOT EXISTS public.tac_gia (
    id bigserial PRIMARY KEY,
    ten_tac_gia varchar(100) NOT NULL,
    tieu_su text,
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_tac_gia_ten ON public.tac_gia(ten_tac_gia);



-- =========================
-- 4) SACH (gộp sách giấy + ebook)
-- =========================
CREATE TABLE IF NOT EXISTS public.sach (
    id bigserial PRIMARY KEY,
    ma_sach varchar(50) NOT NULL UNIQUE,
    tieu_de varchar(255) NOT NULL,
    tac_gia_hien_thi varchar(255), -- optional, để hiển thị nhanh
    nam_xuat_ban int,
    mo_ta text,

    the_loai_id bigint REFERENCES public.the_loai(id),

    -- kho sách giấy (nếu dùng)
    so_luong_tong int NOT NULL DEFAULT 0 CHECK (so_luong_tong >= 0),
    so_luong_con  int NOT NULL DEFAULT 0 CHECK (so_luong_con >= 0),

    -- ebook fields
    co_ban_dien_tu boolean NOT NULL DEFAULT false,
    file_url text,            -- PDF/EPUB
    cover_url text,
    so_trang_dien_tu int CHECK (so_trang_dien_tu >= 0),
    dinh_dang_dien_tu varchar(20), -- PDF/EPUB/...

    an_hien boolean NOT NULL DEFAULT true,
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT ck_so_luong_con_le_tong
      CHECK (so_luong_con <= so_luong_tong)
);

CREATE INDEX IF NOT EXISTS idx_sach_tieu_de ON public.sach(tieu_de);
CREATE INDEX IF NOT EXISTS idx_sach_the_loai ON public.sach(the_loai_id);



-- =========================
-- 5) SACH_TAC_GIA (N-N)
-- =========================
CREATE TABLE IF NOT EXISTS public.sach_tac_gia (
    sach_id bigint NOT NULL REFERENCES public.sach(id) ON DELETE CASCADE,
    tac_gia_id bigint NOT NULL REFERENCES public.tac_gia(id) ON DELETE CASCADE,
    PRIMARY KEY (sach_id, tac_gia_id)
);

CREATE INDEX IF NOT EXISTS idx_sach_tac_gia_tac_gia
ON public.sach_tac_gia(tac_gia_id);



-- =========================
-- 6) TAG
-- =========================
CREATE TABLE IF NOT EXISTS public.tag (
    id bigserial PRIMARY KEY,
    ten_tag varchar(100) NOT NULL UNIQUE,
    mo_ta text,
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_tag_ten ON public.tag(ten_tag);



-- =========================
-- 7) SACH_TAG (N-N)
-- =========================
CREATE TABLE IF NOT EXISTS public.sach_tag (
    sach_id bigint NOT NULL REFERENCES public.sach(id) ON DELETE CASCADE,
    tag_id bigint NOT NULL REFERENCES public.tag(id) ON DELETE CASCADE,
    PRIMARY KEY (sach_id, tag_id)
);

CREATE INDEX IF NOT EXISTS idx_sach_tag_tag ON public.sach_tag(tag_id);



-- =========================
-- 8) PHIEU_MUON (sách giấy)
-- =========================
CREATE TABLE IF NOT EXISTS public.phieu_muon (
    id bigserial PRIMARY KEY,
    ma_phieu varchar(50) NOT NULL UNIQUE,
    doc_gia_id bigint NOT NULL REFERENCES public.nguoi_dung(id),
    nhan_vien_id bigint REFERENCES public.nguoi_dung(id),
    ngay_lap timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    trang_thai varchar(20) NOT NULL DEFAULT 'OPEN', -- OPEN/COMPLETED/CANCELED
    ghi_chu text,
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_phieu_muon_doc_gia ON public.phieu_muon(doc_gia_id);



-- =========================
-- 9) CHI_TIET_PHIEU_MUON
-- =========================
CREATE TABLE IF NOT EXISTS public.chi_tiet_phieu_muon (
    id bigserial PRIMARY KEY,
    phieu_muon_id bigint NOT NULL REFERENCES public.phieu_muon(id) ON DELETE CASCADE,
    sach_id bigint NOT NULL REFERENCES public.sach(id),
    ngay_muon timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_den_han date NOT NULL,
    ngay_tra timestamp,
    trang_thai varchar(20) NOT NULL DEFAULT 'BORROWED', -- BORROWED/RETURNED
    tien_phat numeric(12,2) NOT NULL DEFAULT 0,
    ghi_chu text
);

CREATE INDEX IF NOT EXISTS idx_ctpm_phieu_muon ON public.chi_tiet_phieu_muon(phieu_muon_id);
CREATE INDEX IF NOT EXISTS idx_ctpm_sach ON public.chi_tiet_phieu_muon(sach_id);



-- =========================
-- 10) THE_DOC_SACH_DIEN_TU (thẻ đọc ebook)
-- =========================
CREATE TABLE IF NOT EXISTS public.the_doc_sach_dien_tu (
    id bigserial PRIMARY KEY,
    nguoi_dung_id bigint NOT NULL REFERENCES public.nguoi_dung(id) ON DELETE CASCADE,
    sach_id bigint NOT NULL REFERENCES public.sach(id) ON DELETE CASCADE,

    trang_thai varchar(20) NOT NULL DEFAULT 'READING',
    -- READING / COMPLETED / CANCELED / EXPIRED

    thoi_gian_bat_dau timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    thoi_gian_ket_thuc timestamp,
    han_doc timestamp,

    tien_do numeric(5,2) NOT NULL DEFAULT 0 CHECK (tien_do >= 0 AND tien_do <= 100),
    trang_hien_tai int CHECK (trang_hien_tai >= 0),

    ghi_chu text,
    ngay_tao timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ngay_cap_nhat timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- 1 user chỉ có 1 thẻ READING cho 1 sách
    CONSTRAINT uq_the_doc UNIQUE (nguoi_dung_id, sach_id, trang_thai)
);

CREATE INDEX IF NOT EXISTS idx_the_doc_nguoi_dung
ON public.the_doc_sach_dien_tu(nguoi_dung_id, trang_thai);

CREATE INDEX IF NOT EXISTS idx_the_doc_sach
ON public.the_doc_sach_dien_tu(sach_id);
